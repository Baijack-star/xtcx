# 繁忙状态检测功能说明

## 功能概述

增强版监控程序现在支持在检测到Trae IDE处于繁忙状态时（即未检测到dd.PNG目标按钮），自动检测并点击特定的按钮图像（pp.PNG或kk.PNG）。

## 工作流程

1. **正常检测流程**：程序首先尝试检测dd.PNG按钮
   - 如果检测到 → 执行正常的消息发送流程
   - 如果未检测到 → 进入繁忙状态处理流程

2. **繁忙状态处理流程**：
   - 自动检测屏幕上是否存在pp.PNG或kk.PNG按钮
   - 如果检测到任一按钮 → 自动点击该按钮
   - 如果都未检测到 → 继续等待下次监控循环

## 配置说明

### config.json 配置项

```json
{
  "detection_settings": {
    "match_threshold": 0.9,
    "target_button_image": "dd.PNG",
    "busy_state_images": ["pp.PNG", "kk.PNG"],
    "description": "图像检测相关配置，包括闲置状态检测和繁忙状态下的额外检测"
  }
}
```

- `busy_state_images`: 繁忙状态下要检测的按钮图像列表
- `match_threshold`: 图像匹配阈值（0.9表示90%匹配度）

## 图像文件要求

1. **文件格式**：PNG格式
2. **文件位置**：与监控程序在同一目录
3. **图像质量**：清晰、无压缩失真
4. **尺寸建议**：不宜过大，建议50x30像素左右

## 测试功能

### 创建测试图像
```bash
python create_test_images.py
```

### 运行功能测试
```bash
python test_busy_state_detection.py
```

### 运行完整监控程序
```bash
python enhanced_trae_ide_monitor.py
```

## 日志输出示例

### 检测到繁忙状态按钮时：
```
未发现目标按钮，AI助手可能正在工作中...
✅ 在繁忙状态下检测到 pp.PNG，位置: (100, 200)，匹配度: 0.950
🎯 检测到繁忙状态按钮 pp.PNG，准备点击位置: (100, 200)
✅ 已点击 pp.PNG 按钮
```

### 未检测到任何按钮时：
```
未发现目标按钮，AI助手可能正在工作中...
未检测到任何繁忙状态按钮
```

## 注意事项

1. **图像匹配精度**：确保pp.PNG和kk.PNG图像与实际屏幕显示完全一致
2. **性能影响**：增加了额外的图像检测，可能略微增加CPU使用率
3. **检测顺序**：按配置文件中的顺序检测，检测到第一个匹配的图像即停止
4. **错误处理**：如果图像文件不存在或损坏，会显示警告但不影响主程序运行

## 故障排除

### 问题：检测不到繁忙状态按钮
**解决方案：**
1. 检查pp.PNG和kk.PNG文件是否存在
2. 确认图像内容与屏幕显示一致
3. 调整match_threshold阈值（降低到0.8或0.7）
4. 使用测试工具验证检测功能

### 问题：点击位置不准确
**解决方案：**
1. 确保图像文件清晰无失真
2. 检查屏幕缩放设置
3. 重新截取更精确的按钮图像

## 版本信息

- 功能版本：v1.0
- 兼容性：Windows 10/11
- 依赖库：pyautogui, opencv-python, numpy